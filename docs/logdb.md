日志分析服务（LogDB）提供针对日志类数据的存储、检索与分析服务，同时具备监控与报警功能，帮助用户提升运维、运营效率，快速查找和定位问题，如排查服务器障碍、在线业务监控、应用程序Bug跟踪分析等。

![](http://docs.qiniucdn.com/logdb.png)

## 概念&术语

```
  repo       fields       analyzer       retention      
```

### 日志仓库（repo）

类似于关系型数据库的`表（table）`概念，在日志分析服务中，我们叫它日志仓库。

### 日志字段（fields）

像关系型数据库一样，fields的概念和columns一样，但在日志分析服务中，fields支持的类型有以下几种：

|类型|解释|数据样例|
|:--|:--|:--|
|long|64位整数|998|
|float|单精度64位浮点|10.24|
|date|日期类型，默认格式为RFC3339，可自定义格式|`2017-01-01T15:00:25Z07:00`|
|string|字符串类型，可设置分词器和主键|"qiniu.com"|
|boolean|布尔类型，值为true或false|false|
|object|json格式|-|
|ip|ip地址|127.0.0.1|
|geo_point|经纬度坐标|[ -71.34, 41.12 ]|

### 分词方式（analyzer）

您可以根据自己的搜索习惯和需求，对日志中的field设置分词方式，目前日志分析服务提供以下几种分词方式：

**不分词**

不分词的含义其实是“keyword分词”，意思就是，你必须完整的输入某一个field的内容，才能被搜索到，我们举个例子来说明：

```
假设目前有1个field为A，它的内容是"abcdefg"
假设我们选择了不分词方式，那么如果想搜索到这一条内容，需要在条件框输入：
A:"abcdefg"
这样才能搜索到，如果我们按照以下几种方式，则无法搜索到：
A:"a"
A:"abc"
A:"edf"
```

**不分词不索引**

不分词不索引的含义是指：在任何情况下，输入任何条件，都不会搜索到该field的内容，但在搜索其他field时，如果是整条搜索，那么这个field的内容也会显示出来。

```
假设现在有2个field，分别为：
A:"abcdefg",B:"12345678"
无论我们在条件框输入有关B的任何条件，都不会搜索到
```

**标准分词**

以unicode字符作为结束的标识，过滤掉大部分标点符号，将所有字母变为小写，搜索时只要符合搜索条件的词语出现，就会被搜索到。

```
假设现在有1个field为A，它的内容是"linux-chrome,what's your&name?"
那么使用标准分词，将会被分为："linux,chrome,what's,your,name"
我们的搜索条件包含这些词时，会被搜索到
```
!> 注意：标准分词只适用于全英文字符的field。

**空白分词**

以单词头部和尾部的空格作为分割条件，输入两个空格内的完整内容，即可搜索到相应内容。

```
例：
A="张三 李四 王五"

需要输入以下条件，均可搜到内容：
A:"张三"
A:"李四"
A:"王五"

如果输入以下条件，则无法搜索到内容：
A:"张"
A:"张三 李四"
```

**path分词**

以linux系统路径来进行分词，当搜索时，可以输入完整的路径或者路径前缀来进行匹配，如果输入的条件不是一个正确的前缀，那么将无法正确呈现日志内容。

```
例：
filed A="/usr/local/action.log"

那么需要输入以下条件，均可搜到内容：
A:"/usr"
A:"/usr/local"
A:"/usr/local/action.log"

如果输入以下条件，则无法搜索到内容：
A:"/u"
A:"usr"
A:"/action.log"
```

### 存储时限（retention）

创建仓库时，我们需要指定这个属性，它的意思是指这个仓库内的每一条日志都会被存储和retention一致的天数，超过这个时间的数据会被自动删除，当retention指定为0时，表示永久存储。

## 数据导入

除了通过大数据平台的工作流导出数据到logdb以外，您还可以直接导入本地的JSON文件。在仓库列表页，选择“导入”。

![](http://p5ktjx46s.bkt.clouddn.com/import.png)


## 搜索


搜索界面由搜索栏、仓库列表栏、搜索历史栏组成，通过这三大块您可以完成高效又精细的搜索。

![](http://p5ktjx46s.bkt.clouddn.com/search_interface1.png)

在搜索栏您可以通过选择日志仓库、输入查询语句、选择时间范围来搜索日志。如果日志仓库里面包含时间字段，您可以通过选择时间字段来过滤搜索结果。

### 快速搜索

您可以通过搜索界面的仓库列表快速查询具体某个仓库的全部日志,也可以通过搜索历史快速定位已经做过的搜索，避免重复工作。

![](http://p5ktjx46s.bkt.clouddn.com/quick_search.png)

### 搜索统计视图

搜索模式分为两种，极速模式和详细模式。当您想要看到日志结果随时间的具体统计图时，可以选择详细模式搜索。统计视图显示随时间统计的日志事件数量。点击直方图的任何部分都可以选择那个时间段以查看选定时间范围内的事件。

![](http://p5ktjx46s.bkt.clouddn.com/histogram4.png)

### 字段过滤

日志的field列表显示在搜索结果的左侧，默认情况下搜索结果会显示日志的全部字段，您可以通过字段筛选添加您想查看的字段显示到右侧的日志详细内容中。

![](http://p5ktjx46s.bkt.clouddn.com/choose.png)

### 划词分析

logdb支持搜索结果的划词分析，对搜索结果进行过滤。您可以提取日志结果里的关键字段，选择“加入搜索”，结果会过滤出包含这些关键字段的日志事件，可以同时对多个关键字段划词分析。您可以看到搜索框自动出现了查询语句，大大节省了您的工作量。

![](http://p5ktjx46s.bkt.clouddn.com/line.png)

### 联合搜索

logdb支持多个日志仓库联合搜索，如果您拥有多个日志仓库，这几个仓库里的数据彼此关联，您可以同时选择若干个仓库进行联合搜索，获得更全面的分析结果。

![](http://p5ktjx46s.bkt.clouddn.com/union2.png)

### 搜索语法

日志分析服务提供Lucene、SQL共2种语法来进行日志搜索，但需要注意，一旦有任何数据包含以下符号，无论使用哪种语法，在搜索时，需要以`双引号（""）`包含起来：

```
+  -  
&&  ||  !
( )  { }  [ ] 
^  ”  ~  *  ?  :  \
```


#### 使用 lucene 语法搜索

**条件编写规范**

|名称|语义|
|:--|:--|
|*|查询所有内容|
|AND|query1 AND query2，查询交集|
|OR	|query1 OR query2，查询并集|
|NOT|query1 AND NOT query2，表示符合query1，不符合query2的结果|
|()	|把一个或多个query合并成一个query，提升优先级|
|[]	|区间查询，包括边界|
|{}|区间查询，不包括边界|
|\|转义字符|
|>,=,<,<=,>=|区间查询|

**正则表达式查询**

正则表达式查询条件编写时，以`"/"`开头和结尾。

比如：`name:/joh?n(ath[oa]n)/`

**通配符查询**

使用`?`代替一个字符，`*`代替0或者多个字符

比如：`qu?ck bro*`

* 注意使用这个查询会消耗大量资源，并且速度会降低。


**查询举例：**

字段名称`name`，类型`string`，包含内容`a`的记录：

?>name:a

字段名称`ip`，类型`string`，包含内容`a`或`b`的记录：

?>ip:a OR ip:b

字段名称`hosts`，类型`string`，包含内容`a`或者`b`,不包含`c`的记录：

?>(hosts:a OR hosts:b) AND (NOT hosts:c)

字段名称`ip`，类型`string`，包含内容`a`或`b`，同时字段名称`hosts`，类型`string`，包含内容`c`的记录：

?>(ip:a OR ip:b) AND (hosts:c)

字段名称`createTime`，类型`date`，包含内容`2016-1-1`到`2016-1-2`的记录：

?>createTime:[2016-01-01 TO 2016-01-02]

字段名称`count`，类型`long`或者`float`，内容大于5的记录： 

?>count:>5

更多高级语法和使用方式请参考Lucene Query。


## 报警

报警是logdb新上线的功能，帮您监控日志数据。您只需要设置好报警指标、报警阈值等，当满足触发条件时，通过HTTP接口回调方式，系统会发送报警内容到您添加的地址，提醒您日志哪里出现了异常。

### 配置报警

单击搜索栏下面的“另存为告警”，开始配置报警项。

在报警设置页面，您需要填写以下信息：

![](http://p5ktjx46s.bkt.clouddn.com/warn_setting05.png)

这是一条名称是“响应时间平均数大于1秒报警“的报警配置，它的意思是：每隔1分钟检测最近10分钟内的日志内容，request_time这个字段的平均值如果超过1就触发报警，且15分钟内即使满足报警条件也只触发一次报警。

**运行周期**

您可以设置每隔多久检测一次日志内容报警。

**查询时间**
 
 设定一个查询的时间范围，只针对这个时间范围内的日志检测报警。
 
**分组字段 报警指标 报警阈值**

您可以通过这三条信息创建报警触发条件，其中您可以通过分组字段对数据进行分组，对每个分组的数据分别监控报警指标。通过自由组合，您可以创建以下两种报警触发条件：

1.按事件总数报警

报警指标选择事件总数，给定一个触发报警的阈值。例如，您可以设置报警条件为10分钟内根据machine分组的日志事件总数超过100：

![](http://p5ktjx46s.bkt.clouddn.com/warn06.png)

2.按字段统计数报警

在报警指标里选择统计方式（总和、平均值、最大值、最小值、中位数、分位数），紧跟其后选择字段名，例如，告警触发条件为：根据machine字段分组的日志数据里，request_time在10分钟之内的平均值大于1:

![](http://p5ktjx46s.bkt.clouddn.com/warn07.png)

**报警限制** 

防止您在短时间内遭遇报警轰炸，您可以设置一个固定时间段，在该时间段内出发告警后，系统不再重复发送同类告警信息。

**报警类型**

logdb支持HTTP接口回调报警方式，添加能接受请求的地址，logdb会发送告警内容到改地址，提醒您日志哪里出现了异常。

**测试**

填好配置项以后，您可以点击测试规则测试一下报警设置是否生效。

![](http://p5ktjx46s.bkt.clouddn.com/warn_test.png)

!> 注意：系统只支持每个账号最多创建5条报警。

都设置好以后，您就可以让logdb帮您监控数据啦！


